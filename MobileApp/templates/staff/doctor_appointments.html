{% extends "base.html" %}
{% block title %}Doctor Appointments{% endblock %}

{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold mb-0">
        üìÖ Appointments ‚Äì Dr. {{ doctor.name }}
    </h3>

    <!-- SORT BUTTONS -->
    <div class="btn-group">
        <a href="?sort=desc{% if selected_date %}&date={{ selected_date }}{% endif %}"
           class="btn btn-sm {% if sort == 'desc' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Latest First
        </a>
        <a href="?sort=asc{% if selected_date %}&date={{ selected_date }}{% endif %}"
           class="btn btn-sm {% if sort == 'asc' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Oldest First
        </a>
    </div>
</div>

<!-- DATE FILTER -->
<form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
        <input type="date"
               name="date"
               value="{{ selected_date }}"
               class="form-control"
               onchange="this.form.submit()">
    </div>

    <input type="hidden" name="sort" value="{{ sort }}">

    {% if selected_date %}
    <div class="col-md-2">
        <a href="{% url 'staff:staff_doctor_appointments' doctor.id %}"
           class="btn btn-outline-secondary w-100">
            Clear
        </a>
    </div>
    {% endif %}
</form>

<!-- TABLE -->
<div class="table-responsive">
<table class="table table-bordered table-striped align-middle">
    <thead class="table-dark">
        <tr>
            <th>S.No.</th>
            <th>Slot</th>
            <th>Booked On</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>

    {% for a in appointments %}
    <tr>
        <td>{{ forloop.counter }}</td>

        <td>
            {{ a.slot.date }}<br>
            {{ a.slot.start_time }} ‚Äì {{ a.slot.end_time }}
        </td>

        <td>
            {{ a.created_at|date:"d M Y, h:i A" }}
        </td>

        <!-- STATUS -->
        <td>
            <span class="badge
                {% if a.status == 'COMPLETED' %}
                    bg-success
                {% elif a.status == 'CANCELLED' %}
                    bg-danger
                {% else %}
                    bg-warning text-dark
                {% endif %}
            ">
                {{ a.status }}
            </span>
        </td>

        <!-- PAYMENT -->
        <td>
            {% if a.payment_status == "PAID" %}
                <span class="badge bg-success">Paid</span>
            {% elif a.payment_status == "PENDING" %}
                <span class="badge bg-warning text-dark">Pending</span>
            {% else %}
                <span class="badge bg-danger">Unpaid</span>
            {% endif %}
        </td>

        <!-- ACTIONS -->
        <td>

            <!-- üí∞ MARK PAID (ONLY FOR CLINIC & NOT PAID) -->
            {% if a.consultation_type == "CLINIC" and a.payment_status != "PAID" %}
                <form method="post"
                      action="{% url 'staff:staff_mark_paid' a.id %}?next={{ request.get_full_path }}"
                      class="mb-2">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-sm btn-success w-100">
                        üí∞ Mark Paid
                    </button>
                </form>
            {% endif %}

            <!-- UPDATE STATUS -->
            <form method="post"
                  action="{% url 'staff:staff_update_status' a.id %}?next={{ request.get_full_path }}">
                {% csrf_token %}

                <select name="status"
                        class="form-select form-select-sm"
                        onchange="this.form.submit()">

                    <option selected disabled>Update Status</option>

                    <option value="COMPLETED"
                        {% if a.status == "COMPLETED" %}selected{% endif %}>
                        ‚úÖ Completed
                    </option>

                    <option value="CANCELLED"
                        {% if a.status == "CANCELLED" %}selected{% endif %}>
                        ‚ùå Cancelled
                    </option>
                </select>
            </form>

        </td>
    </tr>

    {% empty %}
    <tr>
        <td colspan="6" class="text-center text-muted">
            No appointments found for this date
        </td>
    </tr>
    {% endfor %}

    </tbody>
</table>
</div>

<a href="{% url 'staff:staff_appointments' %}" class="btn btn-secondary mt-3">
    ‚Üê Back to Doctors
</a>

{% endblock %}
